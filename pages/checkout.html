<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <h2>Checkout</h2>
    <form id="checkout-form">
        <label>Name:</label>
        <input type="text" id="name" required><br>

        <label>Email:</label>
        <input type="email" id="email" required><br>

        <label>Contact:</label>
        <input type="text" id="contact" required><br>

        <h3>Address</h3>
        <label>Line 1:</label>
        <input type="text" id="line1" required><br>

        <label>City:</label>
        <input type="text" id="city" required><br>

        <label>State:</label>
        <input type="text" id="state" required><br>

        <label>Postal Code:</label>
        <input type="text" id="postal_code" required><br>

        <button type="submit">Proceed to Payment</button>
    </form>

    <script>
        const API_BASE_URL = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
            ? "http://localhost:3000/api"
            : "https://hr-dep-1.onrender.com/api";

        async function fetchUserDetails() {
            const token = localStorage.getItem("token");
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/user`, {
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (!response.ok) throw new Error("Invalid response");

                const data = await response.json();
                if (data.success) {
                    document.getElementById('name').value = data.user.name;
                    document.getElementById('email').value = data.user.email;
                    document.getElementById('contact').value = data.user.contact;
                    document.getElementById('line1').value = data.user.address.line1;
                    document.getElementById('city').value = data.user.address.city;
                    document.getElementById('state').value = data.user.address.state;
                    document.getElementById('postal_code').value = data.user.address.postal_code;
                }
            } catch (error) {
                console.error("Error fetching user details:", error);
            }
        }
        
        document.addEventListener("DOMContentLoaded", fetchUserDetails);

        document.getElementById('checkout-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const userData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                contact: document.getElementById('contact').value,
                address: {
                    line1: document.getElementById('line1').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    postal_code: document.getElementById('postal_code').value,
                }
            };

            const token = localStorage.getItem("token");
            if (!token) {
                alert("Please log in to continue.");
                window.location.href = "login.html";
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/cart/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert("Order placed successfully!");
                    window.location.href = "order-success.html";
                } else {
                    alert("Error: " + result.error);
                }
            } catch (error) {
                console.error("Checkout Error:", error);
                alert("An error occurred. Please try again.");
            }
        });
    </script>
</body>
</html>